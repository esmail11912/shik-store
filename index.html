<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>فروشگاه — شیک</title>
<style>
  :root{--bg:#0b0c10;--card:#111217;--text:#e6e8eb;--muted:#9aa0aa;--border:#1e2027;--brand:#7c5cff}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.7 system-ui,"Vazirmatn",sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .muted{color:var(--muted)}
  button{border:1px solid var(--border);background:#151924;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .fab{position:fixed;bottom:14px;inset-inline-end:14px;background:linear-gradient(135deg,#7c5cff,#5ac8fa);color:#fff;border:0;padding:12px 16px;border-radius:999px}
  #drawer{position:fixed;top:0;inset-inline-end:0;width:min(420px,90%);height:100%;background:var(--card);border-inline-start:1px solid var(--border);transform:translateX(110%);transition:.25s;opacity:0;pointer-events:none}
  #drawer.open{transform:translateX(0);opacity:1;pointer-events:auto}
  #drawer header,#drawer footer{padding:12px;border-bottom:1px solid var(--border)}
  #drawer main{padding:12px;display:grid;gap:8px;max-height:calc(100% - 120px);overflow:auto}
</style>
</head>
<body>
  <div class="container">
    <header>
      <strong>فروشگاه شیک</strong>
      <a href="/admin" class="muted" style="text-decoration:none">ادمین</a>
    </header>

    <div id="grid" class="grid"></div>
  </div>

  <button class="fab" id="openCart">🧺 <span id="cc">0</span></button>
  <aside id="drawer" aria-hidden="true">
    <header class="row"><strong>سبد خرید</strong><button id="closeCart">✕</button></header>
    <main id="cart"></main>
    <footer class="row"><span class="muted">جمع کل:</span><strong id="sum">0 USDT</strong></footer>
  </aside>

<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
let PRODUCTS=[], CART=JSON.parse(localStorage.getItem('CART')||'[]');

function fmt(v){return new Intl.NumberFormat('fa-IR',{minimumFractionDigits:2}).format(v)+' USDT';}

async function load(){
  try{
    const r = await fetch('/api/products',{cache:'no-store'});
    const data = await r.json();
    PRODUCTS = Array.isArray(data.products)? data.products : [];
  }catch(e){ PRODUCTS=[]; }
  render();
}

function render(){
  $('#grid').innerHTML = PRODUCTS.map(p=>`
    <article class="card">
      <div class="row"><strong>${p.title?.fa||p.title?.en||p.id}</strong><span class="muted">${fmt(Number(p.price||0))}</span></div>
      <div class="muted" style="font-size:12px">${p.desc?.fa||''}</div>
      <div class="row" style="margin-top:8px"><button onclick="add('${p.id}')">افزودن به سبد</button><span class="muted">${p.sku||''}</span></div>
    </article>`).join('');
  renderCart();
}

function add(id){ const p=PRODUCTS.find(x=>x.id===id); if(!p) return; const i=CART.find(x=>x.id===id); if(i) i.qty++; else CART.push({id:p.id,title:p.title,price:Number(p.price||0),desc:p.desc,qty:1}); save(); openDrawer(); }
function inc(id){ const i=CART.find(x=>x.id===id); if(i){i.qty++; save();} }
function dec(id){ const i=CART.find(x=>x.id===id); if(!i) return; i.qty--; if(i.qty<=0) CART=CART.filter(x=>x.id!==id); save(); }
function save(){ localStorage.setItem('CART', JSON.stringify(CART)); renderCart(); }
function renderCart(){
  $('#cart').innerHTML = CART.length? CART.map(ci=>`
    <div class="row" style="border:1px solid var(--border);border-radius:10px;padding:8px">
      <div style="flex:1">
        <div class="row"><strong>${ci.title?.fa||ci.title?.en||ci.id}</strong><span class="muted">${fmt(ci.price)}</span></div>
        <div class="muted" style="font-size:12px">${ci.desc?.fa||''}</div>
      </div>
      <div class="row"><button onclick="dec('${ci.id}')">−</button><strong>${ci.qty}</strong><button onclick="inc('${ci.id}')">+</button></div>
    </div>`).join('') : '<p class="muted">سبد خالی است.</p>';
  const sum = CART.reduce((s,i)=>s+i.price*i.qty,0); $('#sum').textContent = fmt(sum);
  $('#cc').textContent = CART.reduce((s,i)=>s+i.qty,0);
}
const drawer = $('#drawer'); function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); } function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
$('#openCart').onclick=openDrawer; $('#closeCart').onclick=closeDrawer;

load();
</script>
</body></html>
